PACKAGE = fh-amqp-js

#
# Note: Get the Major/Release/Hotfix numbers from package.json.
# this could easily be done in Node but would introduce an additional
# build dependency.. 
#
PKG_VER:=$(shell grep version package.json| sed s/\"//g| sed s/version://g| sed s/-BUILD-NUMBER//g| tr -d ' '| tr -d ',') 
MAJOR:=$(shell echo $(PKG_VER)| cut -d '.' -f1)
RELEASE:=$(shell echo $(PKG_VER)| cut -d '.' -f2)
HOTFIX:=$(shell echo $(PKG_VER)| cut -d '.' -f3)

BUILD_NUMBER ?= DEV-VERSION
VERSION = $(MAJOR).$(RELEASE).$(HOTFIX)
DIST_DIR  = ./dist
OUTPUT_DIR  = ./output
RELEASE_FILE = $(PACKAGE)-$(VERSION)-$(BUILD_NUMBER).tar.gz
RELEASE_DIR = $(PACKAGE)-$(VERSION)-$(BUILD_NUMBER)

# TODO - automatically get list of test from shell command in test dir
# TESTS=$(wildcard test/test*.js) should work, doesn't.. 
# echo "TESTS: $(TESTS)"
TESTS="test/test-pub.js test/test-sub.js test/test-connection-destroyed.js test/test-bad-pub.js"

all: clean deps test dist

test:  
	@env NODE_PATH=./lib whiskey --real-time --tests $(TESTS)

test-coverage-html: coverage
	@env NODE_PATH=./lib-cov whiskey --real-time --coverage --coverage-reporter html --coverage-dir html-cov --tests $(TESTS)
	@echo "\nOpen: `pwd`/html-cov/index.html in your browser to see coverage stats"

test-coverage-cli: coverage
	@env NODE_PATH=./lib-cov whiskey --real-time --coverage --coverage-reporter cli --tests $(TESTS)

coverage: 
	@rm -rf lib-cov
	@jscoverage lib lib-cov 

dist: deps
	rm -rf $(DIST_DIR) $(OUTPUT_DIR)
	mkdir -p $(DIST_DIR) $(OUTPUT_DIR)/$(RELEASE_DIR)
	cp -r ./lib $(OUTPUT_DIR)/$(RELEASE_DIR)
	cp ./package.json $(OUTPUT_DIR)/$(RELEASE_DIR)
	cp ./fh-amqp-js.js $(OUTPUT_DIR)/$(RELEASE_DIR)
	cp ./LICENSE.txt $(OUTPUT_DIR)/$(RELEASE_DIR) 
	echo "$(MAJOR).$(RELEASE).$(HOTFIX)-$(BUILD_NUMBER)" > $(OUTPUT_DIR)/$(RELEASE_DIR)/VERSION.txt
	sed -i -e s/BUILD-NUMBER/$(BUILD_NUMBER)/ $(OUTPUT_DIR)/$(RELEASE_DIR)/package.json
	tar -czf $(DIST_DIR)/$(RELEASE_FILE) -C $(OUTPUT_DIR) $(RELEASE_DIR)

deps:
	npm install . 

clean: 
	rm -rf lib-cov
	rm -rf html-cov
	rm -rf node_modules
	rm -rf dist
	rm -rf output

.PHONY: coverage test all deps test-coverage dist output
